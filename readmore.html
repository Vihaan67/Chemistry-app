<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Element Details Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <style>
        .explorer-container {
            max-width: 900px;
            margin: 40px auto;
            background: var(--card-bg-light);
            backdrop-filter: blur(12px);
            border-radius: 32px;
            padding: 3rem;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
        }

        body.dark .explorer-container {
            background: var(--card-bg-dark);
        }

        .explorer-grid {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 2rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .data-item {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 16px;
        }

        .data-item strong {
            display: block;
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .summary-box {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e2e8f0;
        }

        .typewriter {
            overflow: hidden;
            display: inline;
        }
    </style>
</head>

<body>
    <div class="explorer-container">
        <header style="text-align: left; margin-bottom: 2rem;">
            <h1 id="elementTitle" style="display: block; margin-bottom: 0.5rem;">Loading...</h1>
            <button onclick="window.close()" class="controls button">Back Home</button>
        </header>

        <div id="detailContent" class="explorer-grid">
            <div>
                <div class="data-grid" id="dataGrid"></div>
                <div id="summary" class="summary-box"></div>
            </div>
            <div id="imagePanel">
                <img id="mainImg" src="" alt=""
                    style="width: 100%; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: white; padding: 1rem;">
            </div>
        </div>
    </div>

    <script>
        // Wrapped in try-catch to prevent SecurityError in local file environments
        try {
            if (window.opener && window.opener.document.body.classList.contains('dark')) {
                document.body.classList.add('dark');
            }
        } catch (e) {
            console.warn("Could not sync theme with opener:", e.message);
        }

        var DATA_URL = 'https://raw.githubusercontent.com/Bowserinator/Periodic-Table-JSON/master/PeriodicTableJSON.json';
        var GEMINI_API_KEY_PART1 = 'AIzaSyBPgleCEBCqQpHUG';
        var GEMINI_API_KEY = GEMINI_API_KEY_PART1 + 'mX0R2CK5QmOawtR1dg';
        var params = new URLSearchParams(window.location.search);
        var symbol = params.get('symbol');

        async function typeWriter(text, elementId, speed = 5) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            let i = 0;
            return new Promise((resolve) => {
                function type() {
                    if (i < text.length) {
                        const char = text.charAt(i);
                        element.innerHTML += char === '\n' ? '<br>' : char;
                        i++;
                        setTimeout(type, speed);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }

        async function fetchAIExplanation(elementName) {
            const prompt = `Provide a very precisely detailed scientific explanation for the chemical element ${elementName}. Include: 
      - Discovery History and Etymology.
      - Natural Occurrence and Abundance.
      - Precise Physical Properties.
      - Chemical Behavior and Common Compounds.
      - Industrial and Real-world Uses.
      - Safety and Hazards.
      - Interesting Scientific Facts.
      Format it as a clean, long narrative. Use bold text for headers. No markdown symbols like # or * other than for bolding.`;

            try {
                // Moving to gemini-2.0-flash-lite on v1beta (1.5-flash was unavailable for this key)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();

                if (data.error) {
                    if (data.error.message.includes('leaked')) {
                        throw new Error("API Key Leaked! Google has deactivated this key for security. Please generate a new one at aistudio.google.com.");
                    }
                    throw new Error(data.error.message);
                }

                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('AI Fetch failed:', error);
                if (error.message.includes('API Key') || error.message.includes('leaked') || error.message.includes('not found')) {
                    return `ðŸš¨ **AI Config Error**: ${error.message}`;
                }
                if (error.message.includes('429')) {
                    return "The AI brain is resting (Quota exceeded). Please try again in a minute!";
                }
                return `Failed to connect: ${error.message}`;
            }
        }

        async function load() {
            try {
                const resp = await fetch(DATA_URL);
                const data = await resp.json();
                const el = data.elements.find(e => e.symbol === symbol);
                if (!el) return;

                document.getElementById('elementTitle').textContent = `${el.name} (${el.symbol})`;

                const fields = [
                    ['Atomic Number', el.number],
                    ['Atomic Mass', el.atomic_mass],
                    ['Category', el.category],
                    ['Phase', el.phase],
                    ['Discovered by', el.discovered_by],
                    ['Named by', el.named_by],
                    ['Boiling Point', el.boil + ' K'],
                    ['Melting Point', el.melt + ' K'],
                    ['Density', el.density + ' g/L']
                ];

                document.getElementById('dataGrid').innerHTML = fields
                    .filter(f => f[1])
                    .map(f => `<div class="data-item"><strong>${f[0]}</strong>${f[1]}</div>`)
                    .join('');

                const summaryElement = document.getElementById('summary');
                summaryElement.innerHTML = '<em>Consulting scientific databases...</em>';

                const aiText = await fetchAIExplanation(el.name);
                await typeWriter(aiText, 'summary');

                const imgUrl = el.image && el.image.url ? el.image.url : `https://images-of-elements.com/${el.symbol.toLowerCase()}.png`;
                document.getElementById('mainImg').src = imgUrl;

                // Add Challenge Button
                const challengeBox = document.createElement('div');
                challengeBox.style.cssText = 'margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #e2e8f0; text-align: center;';
                challengeBox.innerHTML = `
                <h3 style="margin-bottom: 1.5rem;">Think you know ${el.name}?</h3>
                <button id="hardQuizBtn" class="controls button" style="width: 100%; font-weight: 700; background: var(--primary); padding: 1.2rem;">Start ELITE Challenge</button>
                `;
                summaryElement.parentNode.appendChild(challengeBox);

                document.getElementById('hardQuizBtn').onclick = () => {
                    if (window.opener) {
                        window.opener.document.getElementById('quizDifficulty').value = 'hard';
                        window.opener.startQuiz();
                        window.close();
                    }
                };
            } catch (e) {
                console.error('Load failed:', e);
            }
        }

        window.addEventListener('load', load);
    </script>
</body>

</html>